#include <iostream>

#include <mutex>
#include <pcl/io/openni2_grabber.h>
#include <pcl/visualization/pcl_visualizer.h>

using namespace std ;
typedef pcl::PointXYZ T;

class SimpleOpenNIViewer {
public:
  SimpleOpenNIViewer()
      : viewer(new pcl::visualization::PCLVisualizer("PCL OpenNI Viewer")) {}

  void cloud_cb_(const pcl::PointCloud<T>::ConstPtr &cloud) {
    if (!viewer->wasStopped()) {
      mtx.lock();
      viewer->updatePointCloud<T>(cloud, "openni");
      mtx.unlock();
    }
  }

  void run() {
  
   cout<<"Hello 1"<<endl;
   
    pcl::Grabber *interface = new pcl::io::OpenNI2Grabber(
        "@2:3", pcl::io::OpenNI2Grabber::OpenNI_QVGA_30Hz,
        pcl::io::OpenNI2Grabber::OpenNI_QVGA_30Hz);

    cout<<"Hello 2"<<endl;

    pcl::PointCloud<T>::Ptr cloud(new pcl::PointCloud<T>);
    viewer->addPointCloud<T>(cloud, "openni", 0);

   cout<<"Hello 3"<<endl;

    boost::function<void(const pcl::PointCloud<T>::ConstPtr &)> f =
        boost::bind(&SimpleOpenNIViewer::cloud_cb_, this, _1);

       cout<<"Hello 4"<<endl;
       
    interface->registerCallback(f);

       cout<<"Hello 5"<<endl;
    interface->start();

       cout<<"Hello 6"<<endl;
    while (!viewer->wasStopped()) {
      boost::this_thread::sleep(boost::posix_time::millisec(50));
      mtx.lock();
      viewer->spinOnce();
      mtx.unlock();
    }

    interface->stop();
  }

  std::mutex mtx;
  pcl::visualization::PCLVisualizer::Ptr viewer;
};

int main() {
  SimpleOpenNIViewer v;
  v.run();
  return 0;
}

